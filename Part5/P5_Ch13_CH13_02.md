# <Generative model series #5> Distribution Alignment - 2. Marginal Matching & Cycle COnsistency (Dual Learning)

## Supervised pair 모델들의(pix2pix)의 한계.
![](<스크린샷 2023-08-24 오후 3.38.01.png> =300x )
- 생성(Generative Model)에서의 application
    - 순수 𝑝!"#"만 reproduce, 𝑝$%!&'만으로는 응용력이 작다. 
    - A의 style을 가진 것을 B의 input으로 만들고 싶다면? 
    - Supervised pair모델들: pair로 넣어야 한다.
    - 하지만, pair데이터가 만약 너무 비싸다면?

## CycleGAN (2017)
도메인 X와 Y를 mapping하는 함수를 학습하는 것.
- 즉, 𝑥 ∈ 𝑋, 𝑦 ∈ 𝑌이고, 𝑥 ~$p_{data}$(𝑥), 𝑦~$p_{data}$(𝑦)일때,
- 𝐺:𝑋→𝑌와𝐹:𝑌→𝑋를 학습하는것이목표!

2개의 constraint를 만족하며 학습을 진행한다.
1. Marginal matching
- 각 매핑의 output은 source domain margin이라면, 대상 도메인의 empirical distribution과 매칭되어야 한다! 
2. Cycle consistency
- 2번의 매핑으로 한 도메인으로 매핑 후 다시 돌아왔을 때, sample은 원본과 비슷하여야 한다.

## CycleGAN (2017) - Marginal matching
![](<스크린샷 2023-08-24 오후 3.58.22.png> =400x)

Marginal matching loss은 GAN과 같은 형태로 정의한다.   
$G_{XY}, D_Y$에 대해서,   
![Alt text](<스크린샷 2023-08-24 오후 4.00.25.png> =280x)  
$F_{XY}, D_X$에 대해서도 동일하게 loss를 구한다.

## CycleGAN (2017) - Cycle consistency
- Dual learning, back translation이라고도 한다.

    ![Alt text](<스크린샷 2023-08-24 오후 4.06.22.png> =400x)

- 이상적으로 아래를 만족하게 mapping하는 것이 목표! 
    - $F_{YX} (G_{XY} (x)) =x$
    - $G_{XY} (F_{YX} (x)) =y$

- L1 loss로 차이를 구할 때,목적함수는,  
 ![Alt text](<스크린샷 2023-08-24 오후 4.04.29.png> =200x) 

- $𝐿^Y_{cyc}(F_{YX} ,G_{XY})$ 는 위의식의 역을 취해주면된다!

## CycleGAN (2017) - 최종목적함수
최종 목적 함수는  
![Alt text](<스크린샷 2023-08-24 오후 4.07.27.png> =400x)
가 된다.   
- 이때 𝛾는 marginal matching과 cycle consistency를 조절하는 hyperparameter이다.

## CycleGAN (2017) - 결과
![Alt text](<스크린샷 2023-08-24 오후 4.08.43.png> =300x)  
![Alt text](<스크린샷 2023-08-24 오후 4.09.02.png> =400x)

## 참고: DiscoGAN (2017)
- DiscoGAN은 CycleGAN과 2017년도에 동일한 시기에 비슷한 아이디어로 나온 논문! (다만 동기간에 submit되어 둘다 accept되었다.)  
- Reconstruction + Cycle-consistency 을 손실 함수로 같이 이용하고, 거의 같은 모델로 인지되고 있다.
    (참고: https://github.com/nashory/gans-collection.torch/issues/1)
- 손실 함수 구성에서 차이
    - CycleGAN: L1 cycle consistency loss($G_{ab}, G_{ba}$ 두 경우를 더함.)
    - DiscoGAN: L2 cycle consistency loss (각 도메인 별로 따로따로 구한다)
- Generator Model 구조가 조금 다르다.